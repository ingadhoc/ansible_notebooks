---
- name: SysAdmin | Crear y configurar el usuario 'sysadmin'
  tags: sysadmin
  become: true
  block:
    - name: SysAdmin | Crear el usuario con UID 499 y grupo sudo
      ansible.builtin.user:
        name: sysadmin
        uid: 499
        shell: /bin/bash
        create_home: true
        password_lock: true
        groups: sudo
        state: present

    - name: SysAdmin | Asegurar que la clave pública SSH esté autorizada
      ansible.posix.authorized_key:
        user: sysadmin
        state: present
        key: "{{ lookup('file', 'sysadmin.pub') }}"

    - name: SysAdmin | Securizar la configuración del servidor SSH con lineinfile
      ansible.builtin.lineinfile:
        path: /etc/ssh/sshd_config
        regexp: "^{{ item.key }}"
        line: "{{ item.key }} {{ item.value }}"
        state: present
      loop:
        - { key: 'AllowUsers', value: 'sysadmin' }
        - { key: 'PasswordAuthentication', value: 'no' }
        - { key: 'ChallengeResponseAuthentication', value: 'no' }
        - { key: 'PubkeyAuthentication', value: 'yes' }
      notify: Restart sshd # El handler sigue siendo una buena práctica

    - name: SysAdmin | Permitir conexiones SSH entrantes en el firewall
      community.general.ufw:
        rule: allow
        direction: in
        port: '22'
        proto: tcp
        comment: 'Allow incoming SSH for sysadmin user'

    - name: SysAdmin | Agregar 'sysadmin' a sudoers sin requerir contraseña
      ansible.builtin.lineinfile:
        path: /etc/sudoers.d/sysadmin
        line: "sysadmin ALL=(ALL) NOPASSWD:ALL"
        state: present
        create: true
        owner: root
        group: root
        mode: '0440'
        validate: /usr/sbin/visudo -cf %s
