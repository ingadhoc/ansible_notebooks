---
- name: Kubectl | Instalar y configurar kubectl desde el nuevo repositorio de pkgs.k8s.io
  tags: kubectl
  become: true
  block:
    - name: Kubectl | Instalar paquetes de prerrequisitos
      ansible.builtin.apt:
        name: "{{ funcional_kubectl_prerequisites }}"
        state: present

    - name: Kubectl | Eliminar el repositorio antiguo y obsoleto (apt.kubernetes.io)
      ansible.builtin.apt_repository:
        repo: "deb https://apt.kubernetes.io/ kubernetes-xenial main"
        state: absent
        filename: kubernetes

    - name: Kubectl | Verificar si la clave GPG ya est치 instalada
      ansible.builtin.stat:
        path: "{{ external_repos.kubectl.keyring_path }}"
      register: kubectl_gpg_key

    - name: Kubectl | A침adir la nueva clave GPG de Kubernetes
      ansible.builtin.get_url:
        url: "{{ external_repos.kubectl.gpg_url }}"
        dest: /tmp/kubernetes-release.key
        mode: '0644'
      when: not kubectl_gpg_key.stat.exists

    - name: Kubectl | Convertir y guardar la clave GPG
      ansible.builtin.shell: >
        gpg --dearmor -o {{ external_repos.kubectl.keyring_path }} /tmp/kubernetes-release.key
      when: not kubectl_gpg_key.stat.exists
      changed_when: true

    - name: Kubectl | Remover archivo temporal de clave GPG
      ansible.builtin.file:
        path: /tmp/kubernetes-release.key
        state: absent
      when: not kubectl_gpg_key.stat.exists

    - name: Kubectl | Verificar si el repositorio ya est치 configurado
      ansible.builtin.stat:
        path: /etc/apt/sources.list.d/kubernetes-pkgs.list
      register: kubectl_repo_file

    - name: Kubectl | A침adir el nuevo repositorio de Kubernetes (pkgs.k8s.io)
      ansible.builtin.apt_repository:
        repo: "deb [signed-by={{ external_repos.kubectl.keyring_path }}] {{ external_repos.kubectl.repo_url }} /"
        state: present
        filename: kubernetes-pkgs
      register: kubectl_repo_added
      when: not kubectl_repo_file.stat.exists

    - name: Kubectl | Actualizar cache de APT si el repositorio fue agregado
      ansible.builtin.apt:
        update_cache: true
      when: kubectl_repo_added.changed

    - name: Kubectl | Instalar kubectl
      ansible.builtin.apt:
        name: kubectl
        state: present
