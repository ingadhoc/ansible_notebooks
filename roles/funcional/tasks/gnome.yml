---
- name: Gnome - Configurar e instalar extensiones
  tags: gnome

  ansible.builtin.apt:
    name:
      - gnome-tweaks
      - gnome-shell-extension-manager
      - chrome-gnome-shell
      - gnome-shell-extensions
      - dbus-x11
      - python3-psutil
    state: present

- name: GNOME | Aplicar configuraciones de dconf (di치logos y reloj)
  tags: gnome, dconf
  become: true
  become_user: "{{ remote_regular_user }}"
  community.general.dconf:
    key: "{{ item.key }}"
    value: "{{ item.value }}"
    state: present
  loop:
    - { key: "/org/gnome/shell/overrides/attach-modal-dialogs", value: "false" }
    - { key: "/org/gnome/desktop/interface/clock-format", value: "'24h'" }

# Instala las extensiones usando https://github.com/ToasterUwU/install-gnome-extensions
- name: GNOME | Gestionar la instalaci칩n de extensiones
  tags: gnome, gnome-extensions
  become: true
  become_user: "{{ remote_regular_user }}"
  block:
    - name: GNOME | Descargar script de instalaci칩n de extensiones
      ansible.builtin.get_url:
        url: https://raw.githubusercontent.com/ToasterUwU/install-gnome-extensions/master/install-gnome-extensions.sh
        dest: /tmp/install-gnome-extensions.sh
        mode: "0755"

    - name: GNOME | Construir lista final de extensiones a instalar
      ansible.builtin.set_fact:
        extensions_to_install: >
          {{ gnome_extensions_common +
             (gnome_extensions_debian if ansible_facts['distribution'] == 'Debian' else []) +
             (gnome_extensions_ubuntu_2204 if ansible_facts['distribution'] == 'Ubuntu' and ansible_facts['distribution_version'] == '22.04' else []) }}

    - name: GNOME | Instalar todas las extensiones en una sola pasada
      ansible.builtin.command: "/tmp/install-gnome-extensions.sh --overwrite --enable {{ extensions_to_install | join(' ') }}"
      register: extension_install_result
      changed_when: "'Installing extensions' in extension_install_result.stdout"

  always:
    - name: GNOME | Limpiar script de instalaci칩n de extensiones
      ansible.builtin.file:
        path: /tmp/install-gnome-extensions.sh
        state: absent
