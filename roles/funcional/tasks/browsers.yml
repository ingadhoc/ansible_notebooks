- name: Browsers - Instalar Google Chrome de forma limpia y segura
  tags: chrome
  become: true
  block:
    - name: Browsers - Asegurar que 'gnupg' esté instalado
      ansible.builtin.apt:
        name: gnupg
        state: present

    - name: Browsers - Verificar si la llave GPG ya está instalada
      ansible.builtin.stat:
        path: "{{ external_repos.chrome.keyring_path }}"
      register: chrome_gpg_key

    - name: Browsers - Descargar y guardar la llave GPG de Google
      ansible.builtin.get_url:
        url: "{{ external_repos.chrome.gpg_url }}"
        dest: /tmp/linux_signing_key.pub
        mode: '0644'
        owner: root
        group: root
      when: not chrome_gpg_key.stat.exists

    - name: Browsers - Convertir la llave GPG a keyring
      ansible.builtin.command: >
        gpg --dearmor -o {{ external_repos.chrome.keyring_path }} /tmp/linux_signing_key.pub
      when: not chrome_gpg_key.stat.exists

    - name: Browsers - Eliminar fichero temporal de la llave
      ansible.builtin.file:
        path: /tmp/linux_signing_key.pub
        state: absent
      when: not chrome_gpg_key.stat.exists

    - name: Browsers - Verificar si el repositorio ya está configurado
      ansible.builtin.stat:
        path: /etc/apt/sources.list.d/google-chrome.list
      register: chrome_repo_file

    - name: Browsers - Añadir el repositorio de Google Chrome (forma moderna)
      ansible.builtin.apt_repository:
        repo: "deb [arch=amd64 signed-by={{ external_repos.chrome.keyring_path }}] {{ external_repos.chrome.repo_url }} stable main"
        state: present
        filename: google-chrome
      register: chrome_repo_added
      when: not chrome_repo_file.stat.exists

    - name: Browsers - Actualizar cache de APT si el repositorio fue agregado
      ansible.builtin.apt:
        update_cache: true
      when: chrome_repo_added.changed

    - name: Browsers - Instalar el paquete google-chrome-stable
      ansible.builtin.apt:
        name: google-chrome-stable
        state: present
