---
- name: Python | Instalar paquetes de sistema para el entorno de desarrollo
  tags: python
  become: true
  ansible.builtin.apt:
    name: "{{ developer_python_packages }}"
    state: present
    cache_valid_time: "{{ apt_cache_valid_time | default(3600) }}"

- name: Python | Gestionar entorno virtual y herramientas de linting
  tags: python
  become: true
  become_user: "{{ remote_regular_user }}"
  block:
    - name: Python | Verificar si el entorno virtual ya existe
      ansible.builtin.stat:
        path: "{{ developer_python_venv_path }}/bin/activate"
      register: developer_python_venv

    - name: Python | Crear directorio padre para entornos virtuales
      ansible.builtin.file:
        path: "/home/{{ remote_regular_user }}/python-venvs"
        state: directory
        mode: "0755"

    - name: Python | Crear un nuevo y limpio entorno virtual para linters
      ansible.builtin.command: "python3 -m venv {{ developer_python_venv_path }}"
      args:
        creates: "{{ developer_python_venv_path }}/bin/activate"
      register: developer_python_venv_create
      when: not developer_python_venv.stat.exists

    - name: Python | Instalar herramientas de linting en el entorno virtual
      ansible.builtin.pip:
        executable: "{{ developer_python_venv_path }}/bin/pip"
        name: "{{ developer_python_linter_packages }}"
        state: present
      when: developer_python_venv.stat.exists or (developer_python_venv_create is defined and developer_python_venv_create.rc == 0)

- name: Git Hooks | Configurar pre-commit hooks de OCA globalmente
  tags: lint_hooks
  block:
    - name: Git Hooks | Clonar o actualizar el repositorio de maintainer-quality-tools
      become: true
      become_user: "{{ remote_regular_user }}"
      ansible.builtin.git:
        repo: "{{ developer_hooks_repo_url }}"
        dest: "{{ developer_hooks_repo_path }}"
        version: master

    - name: Git Hooks | Encontrar todos los archivos de hooks en el repositorio clonado
      become: true
      ansible.builtin.find:
        paths: "{{ developer_hooks_repo_path }}/git_hooks"
        file_type: file
      register: developer_hook_files

    - name: Git Hooks | Crear enlaces simb√≥licos en la plantilla de hooks de Git
      become: true
      ansible.builtin.file:
        src: "{{ item.path }}"
        dest: "/usr/share/git-core/templates/hooks/{{ item.path | basename }}"
        state: link
        force: true
      loop: "{{ developer_hook_files.files }}"

- name: Tools | Clonar o actualizar repositorio de odoo_log_analyser
  tags: odoo_tools
  become: true
  become_user: "{{ remote_regular_user }}"
  ansible.builtin.git:
    repo: https://github.com/adhoc-dev/odoo_log_analyser.git
    dest: "/home/{{ remote_regular_user }}/repositorios/odoo_log_analyser"
    version: main
