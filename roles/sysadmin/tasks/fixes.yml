---
- name: Sysadmin | Gestionar extensiones de VS Code de forma idempotente
  tags: sysadmin_fixes, code
  become: true
  become_user: "{{ remote_regular_user }}"
  block:
    - name: Sysadmin | Obtener lista de extensiones ya instaladas
      ansible.builtin.command: "code --list-extensions"
      environment:
        DBUS_SESSION_BUS_ADDRESS: "unix:path=/run/user/{{ remote_regular_user_uid }}/bus"
        HOME: "/home/{{ remote_regular_user }}"
      register: sysadmin_installed_extensions
      changed_when: false
      failed_when: sysadmin_installed_extensions.rc not in [0, 134]

    - name: Sysadmin | Instalar solo las extensiones de sysadmin que falten
      ansible.builtin.command: "code --install-extension {{ item }}"
      loop: "{{ vscode_extension_list_sysadmin }}"
      when: item not in sysadmin_installed_extensions.stdout_lines
      environment:
        DBUS_SESSION_BUS_ADDRESS: "unix:path=/run/user/{{ remote_regular_user_uid }}/bus"
        HOME: "/home/{{ remote_regular_user }}"
      register: sysadmin_extension_result
      changed_when: "'already installed' not in sysadmin_extension_result.stdout"
      failed_when: 
        - sysadmin_extension_result.rc not in [0, 134]
        - "'already installed' not in sysadmin_extension_result.stdout"
